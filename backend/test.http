# ===========================================
# Co-Op Backend API Test File
# ===========================================
# Use with VS Code REST Client extension or similar
#
# SETUP:
# 1. Start the backend: npm run dev
# 2. Get a Supabase access token (see instructions below)
# 3. Replace {{token}} with your actual token
# 4. Run requests in order (some depend on previous responses)
#
# HOW TO GET SUPABASE TOKEN:
# Option 1: Use Supabase Dashboard > Authentication > Users > Get JWT
# Option 2: Sign up via Supabase client and extract token
# Option 3: Use the test script at the bottom of this file
# ===========================================

@baseUrl = http://localhost:3000/api/v1
@token = eyJhbGciOiJIUzI1NiIsImtpZCI6ImhXRGxjQmZBY3lsUjJJU04iLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3ZrZ2N1aWdid2hjcmpkeHRyeXh6LnN1cGFiYXNlLmNvL2F1dGgvdjEiLCJzdWIiOiI4ZWFkMDU5NC1lZmVkLTQ3MTEtOGFhOS1hZDJmZjlhYTI0ZmQiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzY1NTY3MDg1LCJpYXQiOjE3NjU1NjM0ODUsImVtYWlsIjoibXIuZ29ibGluMDA3YUBnbWFpbC5jb20iLCJwaG9uZSI6IiIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIiwicHJvdmlkZXJzIjpbImVtYWlsIl19LCJ1c2VyX21ldGFkYXRhIjp7ImVtYWlsX3ZlcmlmaWVkIjp0cnVlfSwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJhYWwiOiJhYWwxIiwiYW1yIjpbeyJtZXRob2QiOiJwYXNzd29yZCIsInRpbWVzdGFtcCI6MTc2NTU2MzQ4NX1dLCJzZXNzaW9uX2lkIjoiZjhmZjlhNTItMGJkNi00MDMwLTk2YjctZWE2ZWU2MzUwZDRkIiwiaXNfYW5vbnltb3VzIjpmYWxzZX0.bH4Jvrywf5iMmPju9uGaA3d0YeT3Nh4H50dnygBjH2A

# Variables that get set from responses (update manually after running)
@userId = 8ead0594-efed-4711-8aa9-ad2ff9aa24fd
@startupId = d21fb632-3cae-486c-9f7e-59adeebc0aee
@sessionId = aeceb473-caa2-4586-b3b7-a01e1ec61b61
@taskId = 
@apiKeyId = 
@webhookId = 

# ===========================================
# HEALTH & METRICS (No Auth Required)
# ===========================================

### Health Check
GET {{baseUrl}}/health

### Prometheus Metrics
GET {{baseUrl}}/metrics

# ===========================================
# USERS - Get Current User
# ===========================================

### Get Current User (creates user if first login)
GET {{baseUrl}}/users/me
Authorization: Bearer {{token}}

### Check Onboarding Status
GET {{baseUrl}}/users/me/onboarding-status
Authorization: Bearer {{token}}

# ===========================================
# ONBOARDING - Complete Startup Setup
# ===========================================

### Complete Onboarding (creates startup)
# Run this ONCE after first login
POST {{baseUrl}}/users/me/onboarding
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "founderName": "John Doe",
  "founderRole": "ceo",
  "companyName": "TechStartup Inc",
  "tagline": "Building the future of AI",
  "description": "We are building an AI-powered platform that helps startups make better decisions through data-driven insights and automated analysis.",
  "website": "https://techstartup.com",
  "industry": "saas",
  "businessModel": "b2b",
  "revenueModel": "subscription",
  "stage": "mvp",
  "foundedYear": 2024,
  "teamSize": "1-5",
  "cofounderCount": 2,
  "country": "United States",
  "city": "San Francisco",
  "operatingRegions": "North America, Europe",
  "fundingStage": "pre_seed",
  "totalRaised": 100000,
  "monthlyRevenue": 5000,
  "isRevenue": "yes",
  "targetCustomer": "Early-stage startups and small businesses looking for AI-powered business intelligence",
  "problemSolved": "Startups struggle to make data-driven decisions due to lack of resources and expertise",
  "competitiveAdvantage": "Multi-LLM council architecture that reduces hallucination and provides more accurate insights"
}

### Update Startup Info
PATCH {{baseUrl}}/users/me/startup
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tagline": "AI-powered startup intelligence",
  "monthlyRevenue": 10000,
  "teamSize": "6-20"
}

### Update User Profile
PATCH {{baseUrl}}/users/me
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "John Smith"
}

# ===========================================
# STARTUPS - View Startups
# ===========================================

### List All Startups (Admin Only)
# Will fail if not admin - that's expected
GET {{baseUrl}}/startups
Authorization: Bearer {{token}}

### Get Startup by ID
# Replace with actual startup ID from onboarding response
GET {{baseUrl}}/startups/{{startupId}}
Authorization: Bearer {{token}}

# ===========================================
# SESSIONS - Chat Sessions
# ===========================================

### Create New Session
# Save the session ID from response for later use
POST {{baseUrl}}/sessions
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "startupId": "{{startupId}}",
  "metadata": {
    "source": "api_test",
    "purpose": "testing"
  }
}

### List My Sessions
GET {{baseUrl}}/sessions
Authorization: Bearer {{token}}

### Get Session by ID
GET {{baseUrl}}/sessions/{{sessionId}}
Authorization: Bearer {{token}}

### Add Message to Session (User message - no agent needed)
POST {{baseUrl}}/sessions/{{sessionId}}/messages
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "user",
  "content": "What legal structure should I use for my AI startup?"
}

### Add Message to Session (Assistant message with agent)
POST {{baseUrl}}/sessions/{{sessionId}}/messages
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "assistant",
  "content": "Based on your AI startup profile, I recommend incorporating as a Delaware C-Corporation...",
  "agent": "legal",
  "metadata": {
    "confidence": 0.85
  }
}

### Get Session Messages
GET {{baseUrl}}/sessions/{{sessionId}}/messages
Authorization: Bearer {{token}}

### Get Full Session History
GET {{baseUrl}}/sessions/{{sessionId}}/history
Authorization: Bearer {{token}}

### Track Session Activity
POST {{baseUrl}}/sessions/{{sessionId}}/activity
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "action": "viewed_legal_advice"
}

### Get Session Activity
GET {{baseUrl}}/sessions/{{sessionId}}/activity
Authorization: Bearer {{token}}

### End Session
POST {{baseUrl}}/sessions/{{sessionId}}/end
Authorization: Bearer {{token}}

# ===========================================
# AGENTS - AI Analysis (Main Feature!)
# ===========================================

### Run Legal Agent (Synchronous)
# This will take 30-60 seconds - runs full LLM Council
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "legal",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "What legal structure should I use for my AI startup? Should I incorporate as a C-Corp or LLC?",
  "documents": []
}

### Run Finance Agent (Synchronous)
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "finance",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "Help me create a financial model for my SaaS startup. What metrics should I track and what should my burn rate look like at pre-seed stage?",
  "documents": []
}

### Run Investor Agent (Synchronous + Web Research)
# This agent uses Google Search grounding for real-time data
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "investor",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "Help me find investors for my AI startup. What VCs are actively investing in AI/ML companies at pre-seed stage?",
  "documents": []
}

### Run Competitor Agent (Synchronous + Web Research)
# This agent uses Google Search grounding for real-time data
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "competitor",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "Analyze my competitive landscape. Who are the main competitors in the AI-powered business intelligence space?",
  "documents": []
}

### Queue Agent Task (Asynchronous)
# Returns immediately with taskId, process in background
POST {{baseUrl}}/agents/queue
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "legal",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "What employment contracts do I need for my first hires?",
  "documents": []
}

### Get Task Status
# Use taskId from queue response
GET {{baseUrl}}/agents/tasks/{{taskId}}
Authorization: Bearer {{token}}

### Cancel Task
DELETE {{baseUrl}}/agents/tasks/{{taskId}}
Authorization: Bearer {{token}}

# Note: SSE streaming endpoint (GET /agents/stream/:taskId) 
# works best in browser or dedicated SSE client

# ===========================================
# API KEYS - Programmatic Access
# ===========================================

### Create API Key
POST {{baseUrl}}/api-keys
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Test API Key",
  "scopes": ["read", "write", "agents"]
}

### List My API Keys
GET {{baseUrl}}/api-keys
Authorization: Bearer {{token}}

### Revoke API Key
DELETE {{baseUrl}}/api-keys/{{apiKeyId}}
Authorization: Bearer {{token}}

# ===========================================
# WEBHOOKS - Event Notifications
# ===========================================

### Create Webhook
POST {{baseUrl}}/webhooks
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Test Webhook",
  "url": "https://webhook.site/your-unique-url",
  "events": ["agent.completed", "session.created"]
}

### List My Webhooks
GET {{baseUrl}}/webhooks
Authorization: Bearer {{token}}

### Get Webhook by ID
GET {{baseUrl}}/webhooks/{{webhookId}}
Authorization: Bearer {{token}}

### Update Webhook
PATCH {{baseUrl}}/webhooks/{{webhookId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "isActive": false
}

### Regenerate Webhook Secret
POST {{baseUrl}}/webhooks/{{webhookId}}/regenerate-secret
Authorization: Bearer {{token}}

### Delete Webhook
DELETE {{baseUrl}}/webhooks/{{webhookId}}
Authorization: Bearer {{token}}

# ===========================================
# NOTION - Export to Notion (Optional)
# ===========================================
# Requires NOTION_API_TOKEN in .env

### Check Notion Integration Status
GET {{baseUrl}}/notion/status
Authorization: Bearer {{token}}

### Search Notion Pages
# Only works if Notion is configured
GET {{baseUrl}}/notion/pages?query=test
Authorization: Bearer {{token}}

### Export to Notion
# Requires a page ID that's shared with your integration
POST {{baseUrl}}/notion/export
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "title": "Legal Analysis - AI Startup Structure",
  "agentType": "legal",
  "content": "## Recommendation\n\nBased on your AI startup profile, I recommend incorporating as a **Delaware C-Corporation**.\n\n### Reasons:\n- Standard for VC-backed startups\n- Easier to issue stock options\n- Familiar to investors\n\n### Next Steps:\n1. File Certificate of Incorporation in Delaware\n2. Create bylaws\n3. Issue founder shares",
  "sources": ["https://example.com/startup-legal-guide"],
  "metadata": {
    "agent": "legal",
    "confidence": 0.85,
    "modelsUsed": ["Llama 3.3 70B", "Gemini 2.0 Flash", "Mixtral 8x7B"]
  }
}

# ===========================================
# MCP SERVER - Expose Agents as MCP Tools
# ===========================================
# MCP Server with mandatory LLM Council cross-critique
# Tools: legal_analysis, finance_analysis, investor_search, competitor_analysis, multi_agent_query

@masterApiKey = master-key-123

### Discover MCP Tools
GET {{baseUrl}}/mcp-server/discover
X-API-Key: {{masterApiKey}}

### Legal Analysis
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "legal_analysis",
  "arguments": {
    "prompt": "Delaware C-Corp vs LLC for AI startup?",
    "companyName": "TechStartup",
    "industry": "saas",
    "stage": "seed",
    "country": "United States"
  }
}

### Finance Analysis
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "finance_analysis",
  "arguments": {
    "prompt": "Key metrics for pre-seed SaaS?",
    "companyName": "TechStartup",
    "industry": "fintech",
    "stage": "pre-seed",
    "country": "United States"
  }
}

### Investor Search (web research)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "investor_search",
  "arguments": {
    "prompt": "Seed VCs for AI startups in US",
    "companyName": "TechStartup",
    "industry": "artificial-intelligence",
    "stage": "seed",
    "country": "United States"
  }
}

### Competitor Analysis (web research)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "competitor_analysis",
  "arguments": {
    "prompt": "Top 5 competitors in AI business intelligence",
    "companyName": "TechStartup",
    "industry": "saas",
    "stage": "mvp",
    "country": "United States"
  }
}

### Multi-Agent Query (query multiple agents at once)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "multi_agent_query",
  "arguments": {
    "prompt": "Prepare for Series A fundraise",
    "agents": ["legal", "finance", "investor"],
    "companyName": "TechStartup",
    "industry": "saas",
    "stage": "seed",
    "country": "United States"
  }
}

# ===========================================
# MCP CLIENT - Connect to External MCP Servers
# ===========================================
# For connecting TO external MCP servers (not exposing)

### List MCP Servers
GET {{baseUrl}}/mcp/servers
Authorization: Bearer {{token}}

### List All MCP Tools
GET {{baseUrl}}/mcp/tools
Authorization: Bearer {{token}}

### Register MCP Server (Admin Only)
POST {{baseUrl}}/mcp/servers
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "id": "custom-mcp",
  "name": "Custom MCP Server",
  "baseUrl": "http://localhost:8080",
  "apiKey": "mcp-server-api-key",
  "enabled": true
}

### Execute MCP Tool
POST {{baseUrl}}/mcp/execute
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "serverId": "custom-mcp",
  "toolName": "search",
  "arguments": {
    "query": "startup funding"
  }
}

# ===========================================
# ANALYTICS (Admin Only)
# ===========================================

### Get Dashboard Stats
GET {{baseUrl}}/analytics/dashboard
Authorization: Bearer {{token}}

### Get Event Aggregation
GET {{baseUrl}}/analytics/events/aggregation?days=7
Authorization: Bearer {{token}}

# ===========================================
# ADMIN - File Management (Admin Only)
# ===========================================
# These require admin role in Supabase

### List Embeddings
GET {{baseUrl}}/admin/embeddings
Authorization: Bearer {{token}}

### Get Embedding Status
GET {{baseUrl}}/admin/embeddings/{{documentId}}
Authorization: Bearer {{token}}

# Note: PDF upload requires multipart/form-data
# Use Postman or curl for file uploads:
# curl -X POST {{baseUrl}}/admin/embeddings/upload \
#   -H "Authorization: Bearer {{token}}" \
#   -F "file=@document.pdf" \
#   -F "filename=document.pdf" \
#   -F "startupId={{startupId}}"

# ===========================================
# QUICK TEST SEQUENCE
# ===========================================
# Run these in order for a complete test:
#
# 1. GET /health (verify server is running)
# 2. GET /users/me (creates user, get userId)
# 3. POST /users/me/onboarding (creates startup, get startupId)
# 4. POST /sessions (create session, get sessionId)
# 5. POST /agents/run with legal agent (test LLM Council)
# 6. GET /sessions/:id/history (verify message saved)
#
# ===========================================
