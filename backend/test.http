# ===========================================
# Co-Op Backend API Test File
# ===========================================
# Use with VS Code REST Client extension
#
# SETUP:
# 1. Start the backend: npm run dev
# 2. Get a Supabase access token (see instructions below)
# 3. Replace {{token}} with your actual token
# 4. Run requests in order (some depend on previous responses)
#
# HOW TO GET SUPABASE TOKEN:
# Option 1: Use Supabase Dashboard > Authentication > Users > Get JWT
# Option 2: Sign up via Supabase client and extract token
# Option 3: Run: npx ts-node scripts/get-token.ts
# ===========================================

@baseUrl = http://localhost:3000/api/v1
@token = YOUR_SUPABASE_JWT_TOKEN_HERE

# Variables - update after running requests
@userId = YOUR_USER_ID
@startupId = YOUR_STARTUP_ID
@sessionId = YOUR_SESSION_ID
@taskId = YOUR_TASK_ID
@apiKeyId = YOUR_API_KEY_ID
@webhookId = YOUR_WEBHOOK_ID
@embeddingId = YOUR_EMBEDDING_ID

# Master API key for MCP Server
@masterApiKey = master-key-123

# ===========================================
# HEALTH & METRICS (No Auth Required)
# ===========================================

### Health Check
GET {{baseUrl}}/health

### Prometheus Metrics (requires API key in production)
GET {{baseUrl}}/metrics

# ===========================================
# USERS - Authentication & Profile
# ===========================================

### Get Current User (creates user if first login)
# Save the userId from response
GET {{baseUrl}}/users/me
Authorization: Bearer {{token}}

### Check Onboarding Status
GET {{baseUrl}}/users/me/onboarding-status
Authorization: Bearer {{token}}

# ===========================================
# ONBOARDING - Complete Startup Setup
# ===========================================

### Complete Onboarding (creates startup)
# Run this ONCE after first login
# IMPORTANT: sector must be one of: fintech, greentech, healthtech, saas, ecommerce
# This determines which RAG documents are used for legal/finance agents
POST {{baseUrl}}/users/me/onboarding
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "founderName": "John Doe",
  "founderRole": "ceo",
  "companyName": "TechStartup Inc",
  "tagline": "Building the future of AI",
  "description": "We are building an AI-powered platform that helps startups make better decisions through data-driven insights and automated analysis.",
  "website": "https://techstartup.com",
  "industry": "saas",
  "sector": "fintech",
  "businessModel": "b2b",
  "revenueModel": "subscription",
  "stage": "mvp",
  "foundedYear": 2024,
  "teamSize": "1-5",
  "cofounderCount": 2,
  "country": "United States",
  "city": "San Francisco",
  "operatingRegions": "North America, Europe",
  "fundingStage": "pre_seed",
  "totalRaised": 100000,
  "monthlyRevenue": 5000,
  "isRevenue": "yes",
  "targetCustomer": "Early-stage startups and small businesses looking for AI-powered business intelligence",
  "problemSolved": "Startups struggle to make data-driven decisions due to lack of resources and expertise",
  "competitiveAdvantage": "Multi-LLM council architecture that reduces hallucination and provides more accurate insights"
}

### Update Startup Info
PATCH {{baseUrl}}/users/me/startup
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tagline": "AI-powered startup intelligence",
  "monthlyRevenue": 10000,
  "teamSize": "6-20",
  "sector": "saas"
}

### Update User Profile
PATCH {{baseUrl}}/users/me
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "John Smith"
}

# ===========================================
# STARTUPS - View Startups
# ===========================================

### Get Startup by ID
GET {{baseUrl}}/startups/{{startupId}}
Authorization: Bearer {{token}}

# ===========================================
# SESSIONS - Chat Sessions
# ===========================================

### Create New Session
# Save the session ID from response
POST {{baseUrl}}/sessions
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "startupId": "{{startupId}}",
  "metadata": {
    "source": "api_test",
    "purpose": "testing"
  }
}

### List My Sessions
GET {{baseUrl}}/sessions
Authorization: Bearer {{token}}

### Get Session by ID
GET {{baseUrl}}/sessions/{{sessionId}}
Authorization: Bearer {{token}}

### Add User Message to Session
POST {{baseUrl}}/sessions/{{sessionId}}/messages
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "user",
  "content": "What legal structure should I use for my AI startup?"
}

### Add Assistant Message to Session
POST {{baseUrl}}/sessions/{{sessionId}}/messages
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "assistant",
  "content": "Based on your AI startup profile, I recommend incorporating as a Delaware C-Corporation...",
  "agent": "legal",
  "metadata": {
    "confidence": 0.85
  }
}

### Get Session Messages
GET {{baseUrl}}/sessions/{{sessionId}}/messages
Authorization: Bearer {{token}}

### Get Full Session History
GET {{baseUrl}}/sessions/{{sessionId}}/history
Authorization: Bearer {{token}}

### Track Session Activity
POST {{baseUrl}}/sessions/{{sessionId}}/activity
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "action": "viewed_legal_advice"
}

### Get Session Activity
GET {{baseUrl}}/sessions/{{sessionId}}/activity
Authorization: Bearer {{token}}

### End Session
POST {{baseUrl}}/sessions/{{sessionId}}/end
Authorization: Bearer {{token}}

# ===========================================
# AGENTS - AI Analysis (Main Feature!)
# ===========================================
# Legal & Finance agents use RAG (domain-specific documents)
# Investor & Competitor agents use Web Research (Google Search)

### Run Legal Agent (RAG + LLM Council)
# Uses documents from legal domain matching your startup's sector
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "legal",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "What legal structure should I use for my AI startup? Should I incorporate as a C-Corp or LLC?",
  "documents": []
}

### Run Finance Agent (RAG + LLM Council)
# Uses documents from finance domain matching your startup's sector
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "finance",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "Help me create a financial model for my SaaS startup. What metrics should I track and what should my burn rate look like at pre-seed stage?",
  "documents": []
}

### Run Investor Agent (Web Research + LLM Council)
# Uses Google Search grounding for real-time investor data
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "investor",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "Help me find investors for my AI startup. What VCs are actively investing in AI/ML companies at pre-seed stage?",
  "documents": []
}

### Run Competitor Agent (Web Research + LLM Council)
# Uses Google Search grounding for real-time competitor data
POST {{baseUrl}}/agents/run
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "competitor",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "Analyze my competitive landscape. Who are the main competitors in the AI-powered business intelligence space?",
  "documents": []
}

### Queue Agent Task (Asynchronous)
# Returns immediately with taskId, process in background
POST {{baseUrl}}/agents/queue
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "agentType": "legal",
  "startupId": "{{startupId}}",
  "sessionId": "{{sessionId}}",
  "prompt": "What employment contracts do I need for my first hires?",
  "documents": []
}

### Get Task Status
GET {{baseUrl}}/agents/tasks/{{taskId}}
Authorization: Bearer {{token}}

### Cancel Task
DELETE {{baseUrl}}/agents/tasks/{{taskId}}
Authorization: Bearer {{token}}

# ===========================================
# API KEYS - Programmatic Access
# ===========================================

### Create API Key
POST {{baseUrl}}/api-keys
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Test API Key",
  "scopes": ["read", "write", "agents"]
}

### List My API Keys
GET {{baseUrl}}/api-keys
Authorization: Bearer {{token}}

### Revoke API Key
DELETE {{baseUrl}}/api-keys/{{apiKeyId}}
Authorization: Bearer {{token}}

# ===========================================
# WEBHOOKS - Event Notifications
# ===========================================

### Create Webhook
POST {{baseUrl}}/webhooks
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Test Webhook",
  "url": "https://webhook.site/your-unique-url",
  "events": ["agent.completed", "session.created"]
}

### List My Webhooks
GET {{baseUrl}}/webhooks
Authorization: Bearer {{token}}

### Get Webhook by ID
GET {{baseUrl}}/webhooks/{{webhookId}}
Authorization: Bearer {{token}}

### Update Webhook
PATCH {{baseUrl}}/webhooks/{{webhookId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "isActive": false
}

### Regenerate Webhook Secret
POST {{baseUrl}}/webhooks/{{webhookId}}/regenerate-secret
Authorization: Bearer {{token}}

### Delete Webhook
DELETE {{baseUrl}}/webhooks/{{webhookId}}
Authorization: Bearer {{token}}

# ===========================================
# NOTION - Export to Notion (Optional)
# ===========================================

### Check Notion Integration Status
GET {{baseUrl}}/notion/status
Authorization: Bearer {{token}}

### Search Notion Pages
GET {{baseUrl}}/notion/pages?query=test
Authorization: Bearer {{token}}

### Export to Notion
POST {{baseUrl}}/notion/export
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "title": "Legal Analysis - AI Startup Structure",
  "agentType": "legal",
  "content": "## Recommendation\n\nBased on your AI startup profile, I recommend incorporating as a **Delaware C-Corporation**.\n\n### Reasons:\n- Standard for VC-backed startups\n- Easier to issue stock options\n- Familiar to investors",
  "sources": ["https://example.com/startup-legal-guide"],
  "metadata": {
    "agent": "legal",
    "confidence": 0.85
  }
}

# ===========================================
# MCP SERVER - Expose Agents as MCP Tools
# ===========================================
# Uses Master API Key authentication
# All tools use mandatory LLM Council cross-critique

### Discover MCP Tools
GET {{baseUrl}}/mcp-server/discover
X-API-Key: {{masterApiKey}}

### Legal Analysis via MCP (uses RAG)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "legal_analysis",
  "arguments": {
    "prompt": "Delaware C-Corp vs LLC for AI startup?",
    "companyName": "TechStartup",
    "industry": "saas",
    "sector": "fintech",
    "stage": "seed",
    "country": "United States"
  }
}

### Finance Analysis via MCP (uses RAG)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "finance_analysis",
  "arguments": {
    "prompt": "Key metrics for pre-seed SaaS?",
    "companyName": "TechStartup",
    "industry": "fintech",
    "sector": "saas",
    "stage": "pre-seed",
    "country": "United States"
  }
}

### Investor Search via MCP (Web Research - no RAG)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "investor_search",
  "arguments": {
    "prompt": "Seed VCs for AI startups in US",
    "companyName": "TechStartup",
    "industry": "artificial-intelligence",
    "sector": "saas",
    "stage": "seed",
    "country": "United States"
  }
}

### Competitor Analysis via MCP (Web Research - no RAG)
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "competitor_analysis",
  "arguments": {
    "prompt": "Top 5 competitors in AI business intelligence",
    "companyName": "TechStartup",
    "industry": "saas",
    "sector": "saas",
    "stage": "mvp",
    "country": "United States"
  }
}

### Multi-Agent Query via MCP
POST {{baseUrl}}/mcp-server/execute
X-API-Key: {{masterApiKey}}
Content-Type: application/json

{
  "tool": "multi_agent_query",
  "arguments": {
    "prompt": "Prepare for Series A fundraise",
    "agents": ["legal", "finance", "investor"],
    "companyName": "TechStartup",
    "industry": "saas",
    "sector": "fintech",
    "stage": "seed",
    "country": "United States"
  }
}

# ===========================================
# MCP CLIENT - Connect to External MCP Servers
# ===========================================

### List MCP Servers
GET {{baseUrl}}/mcp/servers
Authorization: Bearer {{token}}

### List All MCP Tools
GET {{baseUrl}}/mcp/tools
Authorization: Bearer {{token}}

# ===========================================
# ANALYTICS (Admin Only)
# ===========================================

### Get Dashboard Stats
GET {{baseUrl}}/analytics/dashboard
Authorization: Bearer {{token}}

### Get Event Aggregation
GET {{baseUrl}}/analytics/events/aggregation?days=7
Authorization: Bearer {{token}}



# ===========================================
# ADMIN - RAG Document Management
# ===========================================
# Requires admin role in Supabase (app_metadata.role = "admin")
# 
# RAG Flow:
# 1. Admin uploads PDF to Supabase Storage
# 2. File registered with RAG service (status: pending)
# 3. On first user query, vectors are created (lazy loading)
# 4. Vectors expire after 30 days of no access
#
# Domains: legal, finance
# Sectors: fintech, greentech, healthtech, saas, ecommerce

### List All Embeddings
GET {{baseUrl}}/admin/embeddings
Authorization: Bearer {{token}}

### List Embeddings by Domain
GET {{baseUrl}}/admin/embeddings?domain=legal
Authorization: Bearer {{token}}

### List Embeddings by Sector
GET {{baseUrl}}/admin/embeddings?sector=fintech
Authorization: Bearer {{token}}

### List Embeddings by Domain AND Sector
GET {{baseUrl}}/admin/embeddings?domain=legal&sector=fintech
Authorization: Bearer {{token}}

### List Embeddings with Pagination
GET {{baseUrl}}/admin/embeddings?page=1&limit=10
Authorization: Bearer {{token}}

### Get Embedding by ID
GET {{baseUrl}}/admin/embeddings/{{embeddingId}}
Authorization: Bearer {{token}}

### Force Vectorize a File
# Use this to pre-warm vectors before user queries
POST {{baseUrl}}/admin/embeddings/{{embeddingId}}/vectorize
Authorization: Bearer {{token}}

### Delete Embedding (removes vectors + storage file)
DELETE {{baseUrl}}/admin/embeddings/{{embeddingId}}
Authorization: Bearer {{token}}

### Cleanup Expired Vectors (default: 30 days)
POST {{baseUrl}}/admin/embeddings/cleanup
Authorization: Bearer {{token}}

### Cleanup Expired Vectors (custom days)
POST {{baseUrl}}/admin/embeddings/cleanup?days=7
Authorization: Bearer {{token}}

# ===========================================
# ADMIN - PDF Upload (multipart/form-data)
# ===========================================
# Use curl or Postman for file uploads:
#
# curl -X POST "http://localhost:3000/api/v1/admin/embeddings/upload" \
#   -H "Authorization: Bearer YOUR_TOKEN" \
#   -F "file=@/path/to/document.pdf" \
#   -F "filename=startup-legal-guide.pdf" \
#   -F "domain=legal" \
#   -F "sector=fintech"
#
# Response:
# {
#   "success": true,
#   "data": {
#     "id": "uuid",
#     "status": "pending",
#     "storagePath": "legal/fintech/uuid/startup-legal-guide.pdf",
#     "domain": "legal",
#     "sector": "fintech"
#   },
#   "message": "PDF uploaded to legal/fintech (vectors created on first query)"
# }

# ===========================================
# RAG SERVICE DIRECT TESTING (Koyeb)
# ===========================================
# Direct calls to RAG service for debugging
# URL: https://apparent-nanice-afnan-3cac971c.koyeb.app

@ragUrl = https://apparent-nanice-afnan-3cac971c.koyeb.app
@ragApiKey = co-op-rag-secret-key-2024

### RAG Health Check (no auth required)
GET {{ragUrl}}/health

### RAG List Files
GET {{ragUrl}}/rag/files
X-API-Key: {{ragApiKey}}

### RAG List Files by Domain
GET {{ragUrl}}/rag/files?domain=legal
X-API-Key: {{ragApiKey}}

### RAG List Files by Sector
GET {{ragUrl}}/rag/files?sector=fintech
X-API-Key: {{ragApiKey}}

### RAG Get File by ID
GET {{ragUrl}}/rag/files/{{embeddingId}}
X-API-Key: {{ragApiKey}}

### RAG Query (triggers lazy vectorization)
# This will:
# 1. Check for pending files in domain/sector
# 2. Vectorize any pending files
# 3. Search indexed vectors
# 4. Update access timestamps
# 5. Return context (NO LLM generation - backend handles that)
#
# Response format:
# {
#   "context": "Combined text from relevant chunks",
#   "sources": [...],
#   "chunks_found": 5,
#   "vectors_loaded": 0
# }
POST {{ragUrl}}/rag/query
X-API-Key: {{ragApiKey}}
Content-Type: application/json

{
  "query": "What are the key legal considerations for a fintech startup?",
  "domain": "legal",
  "sector": "fintech",
  "limit": 5
}

### RAG Query - Finance Domain
POST {{ragUrl}}/rag/query
X-API-Key: {{ragApiKey}}
Content-Type: application/json

{
  "query": "What financial metrics should a SaaS startup track?",
  "domain": "finance",
  "sector": "saas",
  "limit": 5
}

### RAG Force Vectorize
POST {{ragUrl}}/rag/vectorize/{{embeddingId}}
X-API-Key: {{ragApiKey}}

### RAG Delete File
DELETE {{ragUrl}}/rag/files/{{embeddingId}}
X-API-Key: {{ragApiKey}}

### RAG Cleanup Expired Vectors
POST {{ragUrl}}/rag/cleanup?days=30
X-API-Key: {{ragApiKey}}

# ===========================================
# QUICK TEST SEQUENCE
# ===========================================
# Run these in order for a complete test:
#
# 1. GET /health (verify server is running)
# 2. GET /users/me (creates user, get userId)
# 3. POST /users/me/onboarding (creates startup, get startupId)
#    - Set sector to match your RAG documents!
# 4. POST /sessions (create session, get sessionId)
# 5. POST /agents/run with legal agent (test RAG + LLM Council)
# 6. POST /agents/run with investor agent (test Web Research)
# 7. GET /sessions/:id/history (verify messages saved)
#
# For RAG testing:
# 1. Upload PDF via curl (see above)
# 2. GET /admin/embeddings (verify file registered)
# 3. POST /agents/run with legal/finance agent
#    - This triggers lazy vectorization
# 4. GET /admin/embeddings/:id (verify status = "indexed")
#
# ===========================================
